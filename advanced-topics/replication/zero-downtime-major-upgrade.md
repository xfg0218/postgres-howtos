前段时间（2024 年 1 月），在 HackerNews 上，讨论了 knock.app 的一篇文章，

在 [零停机时间 Postgres 升级上](https://news.ycombinator.com/item?id=38616181) 。

[Alexander Sosna](https://x.com/xxorde) （GitLab） 发表了一场演讲，解释了 GitLab 的大型集群如何在重负载下升级而没有任何停机时间——我强烈建议您看看这项工作

适当的零停机升级背后有很多细节，有很多挑战需要解决，这里我只介绍一个高级计划。它适用于非常大（数十 TiB）的集群，具有许多副本，并且在高 TPS（数十个 10k）下工作。此处描述的过程涉及逻辑复制（使用 "物理到逻辑" 技巧）和 PgBouncer 的 PAUSE/RESUME（假设使用 PgBouncer）。

详细的材料将需要编写几个单独的作方法。

该过程包括 2 个步骤：

1. **升级**：创建新集群，在新的 Postgres 主要版本上运行。
2. **SWITCHOVER**：流量的逐步切换。

**第 1 步：升级**

当第一次从头开始创建一个新集群（ `initdb` ），然后基于它创建一个全新的逻辑副本（创建逻辑订阅时 `copy_data = true` ）时，有一个“标准”方法。但是，这种逻辑副本配置方式需要花费大量时间，并且在重负载下执行可能会非常成问题。

另一种方法是获取物理副本并将其转换为逻辑副本。了解逻辑插槽的 LSN 位置并使用 `recovery_target_lsn` 相对容易做到这一点。这个配方被称为 "physical2logical" 转换，它允许基于物理副本创建逻辑副本（例如，基于云快照在分钟内创建），可靠、快速。

然而，将物理2逻辑转换与 `pg_upgrade` 相结合时应小心进行。详情请点击 [此处](https://www.postgresql.org/message-id/flat/20230217075433.u5mjly4d5cr4hcfe%40jrouhaud)。

步骤：

1. 创建一个新集群，该集群将成为使用级联物理复制的辅助集群（Patroni 支持）。
2. 确保新集群的领导者不会明显落后于旧集群的主集群。
3. 以正确的顺序停止新集群的节点（确保停止的副本与其领导者完全同步）。
4. 在旧集群的主集群上，创建一个逻辑槽和发布 `FOR ALL TABLES`（这不需要表级锁，因此我们不需要低lock_timeout和重试）并记住槽的位置。
5. 重新配置新集群的领导者，将 `recovery_target_lsn` 设置为记住的插槽的 LSN，并禁用 `restore_command`。
6. 启动新集群的领导者和副本，让它们达到所需的 LSN。然后领导才能得到提拔。
7. 按正确的顺序再次停止新集群的节点。
8. 在新集群的领导者上运行 `pg_upgrade --link`。
9. 在新集群的副本上使用 `rsync --hard-links --size-only` - 这是有争议的步骤（请参阅此处的详细信息），但这是大多数人使用 `pg_upgrade --link` 进行就地（无逻辑复制）升级的方法，并且还没有发明其他快速替代方案。
10. 将新集群的领导者（现在已经是主集群）配置为使用逻辑复制 - 创建订阅，`copy_data = false`，并让它赶上工作的旧集群。

在所有这些步骤中，旧集群将启动并运行，而新集群对用户不可见。这为您提供了在生产中测试整个过程的巨大好处（在较低环境中进行适当测试后）。

**第 2 步：切换**

首先，切换只读 （RO） 流量是有意义的。如果应用程序允许，首先仅将部分 RO 流量重定向到新副本是有意义的。这需要在负载平衡代码中进行高级复制滞后检测（请参阅：[如何确定复制滞后 - 混合情况：逻辑和物理]()。

当需要重定向 RW 流量时，为了实现零停机时间，可以使用 PgBouncer 的 PAUSE/RESUME。如果有多个 PgBouncer 节点（在单独的主机/端口上运行，或涉及SO_REUSEPORT），则实现 PAUSE 获取的正常方法非常重要。一旦获取了所有 PAUSE，就可以重定向流量，就可以发出 RESUME。在此之前，请务必确保所有写入都完全传播到新的主数据库。

制定措施来保护旧集群免受来自应用程序或用户的写入非常重要——例如调整 `pg_hba.conf` 或关闭集群。但是，对于高级回滚功能，实现 "reverse" 逻辑复制是有意义的，其方式与 "forward" 复制相同，在切换期间进行设置。在这种情况下，允许对旧集群进行写入，但只能通过逻辑复制。反向复制允许回滚，即使在整个过程完成一段时间后，这使得整个过程从任何时候都可以完全可逆。

如前所述，有很多方面需要解决。您可以在 [演讲](https://www.postgresql.eu/events/pgconfeu2023/schedule/session/4791-how-we-execute-postgresql-major-upgrades-at-gitlab-with-zero-downtime/) 中找到详细信息 - 幻灯片和视频 在这里发布。
